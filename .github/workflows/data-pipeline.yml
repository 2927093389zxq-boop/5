name: Data Pipeline CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'data/**'
      - 'scripts/**'
      - '.github/workflows/data-pipeline.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'data/**'
      - 'scripts/**'
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate-pipeline:
    name: Validate Data Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate configuration files
        run: |
          echo "Validating source configuration..."
          node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('data/config/source.config.json', 'utf8')); console.log('✓ source.config.json is valid JSON');"
          
          echo "Validating schemas..."
          for schema in data/schema/*.json; do
            if [ -f "$schema" ]; then
              node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('$schema', 'utf8')); console.log('✓ $schema is valid JSON');"
            fi
          done
      
      - name: Check directory structure
        run: |
          echo "Checking required directories..."
          for dir in data/raw data/processed data/seeds data/schema data/metadata data/config; do
            if [ -d "$dir" ]; then
              echo "✓ $dir exists"
            else
              echo "✗ $dir is missing"
              exit 1
            fi
          done
      
      - name: Test fetch script syntax
        run: |
          echo "Validating fetch_source.mjs syntax..."
          node --check scripts/fetch_source.mjs
          echo "✓ fetch_source.mjs syntax is valid"
      
      - name: Test process script syntax
        run: |
          echo "Validating process_data.mjs syntax..."
          node --check scripts/process_data.mjs
          echo "✓ process_data.mjs syntax is valid"
      
      - name: Test seed generation script syntax
        run: |
          echo "Validating generate_seeds.mjs syntax..."
          node --check scripts/generate_seeds.mjs
          echo "✓ generate_seeds.mjs syntax is valid"
      
      - name: Run integration test
        run: |
          echo "Running pipeline integration test..."
          if [ -f "scripts/test_pipeline.mjs" ]; then
            node scripts/test_pipeline.mjs
          else
            echo "⚠ Integration test script not found, skipping"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security checks
        run: |
          echo "Checking for sensitive data in configs..."
          
          # Check for common sensitive patterns
          if grep -r -i "password\|api_key\|secret\|token" data/config/*.json | grep -v "PLACEHOLDER\|example"; then
            echo "⚠ Warning: Possible sensitive data found in config files"
          else
            echo "✓ No sensitive data patterns detected"
          fi
      
      - name: Verify anonymization config
        run: |
          echo "Verifying anonymization settings..."
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('data/config/source.config.json', 'utf8'));
            
            for (const source of config.sources) {
              if (source.enabled && source.anonymization) {
                if (source.anonymization.enabled) {
                  console.log(\`✓ Source '\${source.name}' has anonymization enabled\`);
                } else {
                  console.log(\`⚠ Source '\${source.name}' has anonymization disabled\`);
                }
              }
            }
          "
